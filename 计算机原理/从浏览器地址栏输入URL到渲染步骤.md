## 浏览器器输入网址后发生了什么？

![image-20220220200822197](/Users/wangyafei/Library/Application Support/typora-user-images/image-20220220200822197.png)

1、URL解析（DNS解析）

2、建立TCP链接（三次握手、四次挥手）

3、浏览器解析、执行、渲染

## 1、URL解析

1. 浏览器缓存：浏览器一般会缓存DNS记录一段时间，不同浏览器缓存时间不同，一般2～30分钟不等；

2. 系统缓存：当浏览器未查询到缓存，会查询系统host文件；

3. 路由器缓存：路由器一般也会有自己DNS缓存，前面请求发给路由器，查找ISP（互联网服务提供商）缓存的DNS的服务

4. DNS服务器查找

   1. 递归查询：如果上述步骤扔未获取，则ISP的DNS服务器会进行递归查询，

      递归查询就是如果主机所查询的本地服务器也不知道被查询的域名的IP地址信息，那么本地域名服务器就以DNS客户的身份，向其根域名服务器继续发送查询请求报文，而不是让该主机自己进行下一步查询（本地域名服务器是通过DHPC协议获取地址，DHPC是负责分配IP地址的）

   2. 迭代查询：本地域名服务器采用迭代查询，先向一个根域名服务器查询。

      本地域名服务器向根域名服务器的查询一般都是采用迭代查询。所谓迭代查询就是当根域名服务器收到本地域名服务器发出的查询请求报文后，要么告诉本地服务器下一步查询哪一个域名服务器，然后本地域名服务器进行后续查询。（而不是替代本地域名服务器进行后续查询） 

![image-20220220194256850](/Users/wangyafei/Library/Application Support/typora-user-images/image-20220220194256850.png)

![image-20220220194634724](/Users/wangyafei/Library/Application Support/typora-user-images/image-20220220194634724.png)



## 2、建立连接

### 三次握手

![image-20220220195235582](/Users/wangyafei/Library/Application Support/typora-user-images/image-20220220195235582.png)

主要问题：

- 为什么不是两次握手

  1. client发送连接请求时，网络原因，sever没有接收到，客户端会以为请求丢失会再发送一个连接请求。这是网络恢复，服务会接收到多个连接请求，造成服务端资源浪费；
  2. 当服务器端接收到请求后，未收到client确认返回，会重新发送确认确认信息，若多次未收到client确认会关闭连接；

- 为什么不是四次握手

  1、因为通讯是不能保证是100%的，客户端和服务器都不确定消息是否完完全全被接收到了，增加握手的次数，并不能显著提高可靠性了，只能无线趋近于100%。

### 四次挥手

![image-20220220195304153](/Users/wangyafei/Library/Application Support/typora-user-images/image-20220220195304153.png)

主要问题：

- 为什么建立连接是三次握手，关闭连接确是四次挥手

​	建立连接的时候， 服务器在LISTEN状态下，收到建立连接请求的SYN报文后，把ACK和SYN放在一个报文里发送给客户端
​	关闭连接时，服务器收到对方的FIN报文时，仅仅表示对方不再发送数据了但是还能接收数据，而自己也未必全部数据都发送给对方了，所以己方可以立即关闭，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接，因此，己方ACK和FIN一般都会分开发送，从而导致多了一次